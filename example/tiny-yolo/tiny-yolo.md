# tiny-yolo サンプル

## 準備
YAD2K: Yet Another Darknet 2 Kerasが動くようにする。
### YAD2Kのインストール

作業用ディレクトリへ移動し、git cloneする。
```
git clone https://github.com/allanzelener/YAD2K
```

### Keras用に重みデータを変換する。
tiny-yolo-cov版のcfgファイルと、重みデータをダウンロードする。
```
cd YAD2K
wget https://raw.githubusercontent.com/pjreddie/darknet/master/cfg/tiny-yolo-voc.cfg
wget https://pjreddie.com/media/files/tiny-yolo-voc.weights
```
ダウンロードした重みファイルをhdf5形式に変換する。
```
./yad2k.py tiny-yolo-voc.cfg tiny-yolo-voc.weights tiny-yolo.h5
```
成功すると、以下の用に表示される。
```
Total params: 15,867,885.0
Trainable params: 15,861,773.0
Non-trainable params: 6,112.0
_________________________________________________________________
None
Saved Keras model to tyolo.h5
Read 15867885 of 15867885.0 from Darknet weights.
```
### 変換したデータのコピー
変換してできたtyolo.h5を、<コキュートスのインストールディレクトリ>/example/tiny-yolo/keras/weightへコピーする

コマンドの例(~/tmp/以下にコキュートスをインストールした場合)
```
cp tyolo.h5 ~/tmp/cocytus/example/tiny-yolo/keras/weight/
```

## コキュートスによるＣ言語生成
### 重みの変換
<コキュートスのインストールディレクトリ>/example/tiny-yolo/keras ディレクトリへ移動し、tiny-yolo.pyを実行する。
以下、コマンド例。
```
cd ~/tmp/cocytus/example/tiny-yolo/keras
python3 tiny-yolo.py
```
このように領域が表示されれば成功。
```
sheep 0.814217 (428, 145) (590, 336)
person 0.665931 (178, 109) (282, 371)
cow 0.438515 (66, 267) (188, 356)
finish
```

### Cソースの作成
tiny-yoloディレクトリに戻り、コキュートスを起動する。
```
cd ..
python3 ../../cocytus/cocytus.py tiny-yolo.ini
```
最後にこのよう表示されれば成功
```
save conv2d_9/bias:0 to c/weight/conv2d_9_bias_z.npy
finish
```

### Cソースのコンパイル
cディレクトリへ移動、コンパイル
```
cd .
cmake .
make
```

### Cの実行結果
cqt_tyoloが実行ファイルです。そのまま実行できます。
```
./cqt_tyolo
```

Ｃプログラムには、領域を描画する機能はありません。実行後、このように表示されれば正しく動作しています。

```
sheep 0.814217 (415, 145), (571, 336)
person 0.665931 (172, 109), (273, 371)
cow 0.438520 (64, 267), (182, 356)
```

### 入力データについて
githubからクローンした状態では、実行時のディレクトリから"../img/person.jpg.npy"のファイルを処理して終了します。別のファイルを読みこんだり、連続処理が必要な場合は、cqt_tyolo.cを書き換えてください。
cqt_tyolo.cは、コキュートスのＣ言語生成では上書きされません。

別の画層データをコキュートスで読み込めるようにするには、


## ネットワーク情報
```
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
conv2d_1 (Conv2D)            (None, 416, 416, 16)      432
_________________________________________________________________
batch_normalization_1 (Batch (None, 416, 416, 16)      64
_________________________________________________________________
leaky_re_lu_1 (LeakyReLU)    (None, 416, 416, 16)      0
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 208, 208, 16)      0
_________________________________________________________________
conv2d_2 (Conv2D)            (None, 208, 208, 32)      4608
_________________________________________________________________
batch_normalization_2 (Batch (None, 208, 208, 32)      128
_________________________________________________________________
leaky_re_lu_2 (LeakyReLU)    (None, 208, 208, 32)      0
_________________________________________________________________
max_pooling2d_2 (MaxPooling2 (None, 104, 104, 32)      0
_________________________________________________________________
conv2d_3 (Conv2D)            (None, 104, 104, 64)      18432
_________________________________________________________________
batch_normalization_3 (Batch (None, 104, 104, 64)      256
_________________________________________________________________
leaky_re_lu_3 (LeakyReLU)    (None, 104, 104, 64)      0
_________________________________________________________________
max_pooling2d_3 (MaxPooling2 (None, 52, 52, 64)        0
_________________________________________________________________
conv2d_4 (Conv2D)            (None, 52, 52, 128)       73728
_________________________________________________________________
batch_normalization_4 (Batch (None, 52, 52, 128)       512
_________________________________________________________________
leaky_re_lu_4 (LeakyReLU)    (None, 52, 52, 128)       0
_________________________________________________________________
max_pooling2d_4 (MaxPooling2 (None, 26, 26, 128)       0
_________________________________________________________________
conv2d_5 (Conv2D)            (None, 26, 26, 256)       294912
_________________________________________________________________
batch_normalization_5 (Batch (None, 26, 26, 256)       1024
_________________________________________________________________
leaky_re_lu_5 (LeakyReLU)    (None, 26, 26, 256)       0
_________________________________________________________________
max_pooling2d_5 (MaxPooling2 (None, 13, 13, 256)       0
_________________________________________________________________
conv2d_6 (Conv2D)            (None, 13, 13, 512)       1179648
_________________________________________________________________
batch_normalization_6 (Batch (None, 13, 13, 512)       2048
_________________________________________________________________
leaky_re_lu_6 (LeakyReLU)    (None, 13, 13, 512)       0
_________________________________________________________________
max_pooling2d_6 (MaxPooling2 (None, 13, 13, 512)       0
_________________________________________________________________
conv2d_7 (Conv2D)            (None, 13, 13, 1024)      4718592
_________________________________________________________________
batch_normalization_7 (Batch (None, 13, 13, 1024)      4096
_________________________________________________________________
leaky_re_lu_7 (LeakyReLU)    (None, 13, 13, 1024)      0
_________________________________________________________________
max_pooling2d_7 (MaxPooling2 (None, 13, 13, 1024)      0
_________________________________________________________________
conv2d_8 (Conv2D)            (None, 13, 13, 1024)      9437184
_________________________________________________________________
batch_normalization_8 (Batch (None, 13, 13, 1024)      4096
_________________________________________________________________
leaky_re_lu_8 (LeakyReLU)    (None, 13, 13, 1024)      0
_________________________________________________________________
max_pooling2d_8 (MaxPooling2 (None, 13, 13, 1024)      0
_________________________________________________________________
conv2d_9 (Conv2D)            (None, 13, 13, 125)       128125
=================================================================
Total params: 15,867,885.0
Trainable params: 15,861,773.0
Non-trainable params: 6,112.0
_________________________________________________________________

```

## 謝辞
重みの変換だけでなく、NN処理後の後処理についても参考にさせていただきました。ありがとうございます。

https://github.com/allanzelener/YAD2K